<?xml version="1.0" encoding="UTF-8"?>
<project name="custom_rules">
  <xmlproperty file="AndroidManifest.xml" prefix="mymanifest" collapseAttributes="true"/>
  <property name="build.dir" value="bin/${mymanifest.manifest.android:versionName}/" />
  <property name="deploy.location" value="../../deploy"/>

  <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

  <target name="-pre-build">
    <ant antfile="build_dependencies.xml" target="build_dependencies" />

    <propertyfile file="version.properties" comment="Version info">
      <entry key="build.number" default="0" type="int" operation="+" value="1" />
    </propertyfile>
    <loadproperties srcFile="version.properties" />

    <if>
      <condition><equals arg1="${build.target}" arg2="release" /></condition>
      <then>
        <!-- make sure on_behalf_of is commented out -->
        <replaceregexp file="assets/warworlds.properties"
                       match="^#?user.on_behalf_of=.*$" flags="gm"
                       replace="#user.on_behalf_of=nobody" />

        <!-- make sure debug is set to 'false' -->
        <replaceregexp file="assets/warworlds.properties"
                       match="^debug=.*$" flags="gm"
                       replace="debug=false" />

        <!-- change all of the in-app purchase fields to their defaults -->
        <replaceregexp file="assets/warworlds.properties"
                       match="^iap\.([^=]+)=.*$" flags="gm"
                       replace="iap.\1=\1" />

        <!-- make sure the welcome.rss field is pointing to the live server -->
        <replaceregexp file="assets/warworlds.properties"
                       match="^welcome.rss=.*$" flags="gm"
                       replace="welcome.rss=http://www.war-worlds.com/forum/announcements/rss" />

        <!-- update the version number -->
        <replaceregexp file="AndroidManifest.xml"
                       match="android:versionCode=&quot;(.*)&quot;"
                       flags="g"
                       replace="android:versionCode=&quot;${build.number}&quot;" />

        <replaceregexp file="AndroidManifest.xml"
                       match="android:versionName=&quot;(.*)&quot;"
                       flags="g"
                       replace="android:versionName=&quot;0.4.${build.number}&quot;" />
      </then>
    </if>
  </target>

  <target name="-post-build">
    <!-- put debug back to 'true' -->
    <replaceregexp file="assets/warworlds.properties"
                   match="^debug=.*$"
                   flags="gm"
                   replace="debug=true" />

    <!-- delete the java-projects.jar file that was created. -->
    <delete file="libs/java-projects.jar" />

    <!-- copy the proguard mapping.txt to the server's deploy folder, so that it can
         be copied to the server (so the server can de-obfuscate stack traces) -->
    <copy tofile="${deploy.location}/data/proguard/mapping-${build.number}.txt"
          file="bin/proguard/mapping.txt" />
    <copy tofile="../../apk/warworlds-${build.number}-mapping.txt"
          file="bin/proguard/mapping.txt" />
    <copy tofile="../../apk/warworlds-${build.number}.apk"
          file="${out.final.file}" />
  </target>
</project>
