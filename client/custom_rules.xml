<?xml version="1.0" encoding="UTF-8"?>
<project name="custom_rules">
  <xmlproperty file="AndroidManifest.xml" prefix="mymanifest" collapseAttributes="true"/>
  <property name="build.dir" value="bin/${mymanifest.manifest.android:versionName}/" />

  <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

  <target name="-pre-build">
    <ant antfile="build_dependencies.xml" target="build_dependencies" />

    <exec executable="svnversion" outputproperty="svnversion"/>
    <propertyregex property="svnversion"
                   input="${svnversion}"
                   regexp="([0-9]+).*"
                   replace="\1"
                   global="true" />

    <propertyfile file="version.properties" comment="Version info">
      <entry key="build.date" type="date" value="now" pattern="yyyyMMdd" />
      <entry key="build.number" default="0" type="int" operation="+" value="1" />
      <entry key="build.svn" type="int" value="${svnversion}" />
    </propertyfile>
    <loadproperties srcFile="version.properties" />

    <if>
      <condition><equals arg1="${build.target}" arg2="release" /></condition>
      <then>
        <!-- make sure on_behalf_of is commented out -->
        <replaceregexp file="assets/warworlds.properties"
                       match="^#?user.on_behalf_of=.*$"
                       flags="gm"
                       replace="#user.on_behalf_of=nobody" />

        <!-- make sure debug is set to 'false' -->
        <replaceregexp file="assets/warworlds.properties"
                       match="^debug=.*$"
                       flags="gm"
                       replace="debug=false" />

        <!-- change all of the in-app purchase fields to their defaults -->
        <replaceregexp file="assets/warworlds.properties"
                       match="^iap\.([^=]+)=.*$"
                       flags="gm"
                       replace="iap.\1=\1" />

        <!-- update the version number -->
        <replaceregexp file="AndroidManifest.xml"
                       match="android:versionCode=&quot;(.*)&quot;"
                       flags="g"
                       replace="android:versionCode=&quot;${build.number}&quot;" />
        <replaceregexp file="AndroidManifest.xml"
                       match="android:versionName=&quot;(.*)&quot;"
                       flags="g"
                       replace="android:versionName=&quot;0.1.${build.date}.${build.svn}&quot;" />
      </then>
    </if>
  </target>

  <target name="-post-build">
    <!-- put debug back to 'true' -->
    <replaceregexp file="assets/warworlds.properties"
                   match="^debug=.*$"
                   flags="gm"
                   replace="debug=true" />
  </target>
</project>
