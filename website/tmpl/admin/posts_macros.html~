{% macro form(post, upload_url) -%}
<div id="post-container">
  <form method="post">
    <fieldset id="post-details">
      <legend>Post Details</legend>
        <div class="post-title">
          <label for="post-title">Title:</label>
          <input type="text" name="post-title" id="post-title"{% if post %} value="{{post.title}}"{% endif %}>
        </div>
        <textarea name="post-content" id="post-content">{% if post %}{{post.html|escape}}{% endif %}</textarea>
        <div class="post-title">
          <label for="post-tags">Tags:</label>
          <input type="text" name="post-tags" id="post-tags"{% if post %} value="{{post|post_tags}}"{% endif %}>
        </div>
        <div class="post-title">
          <label for="post-slug">Slug:</label>
          <input type="text" name="post-slug" id="post-slug"{% if post and post.slug %} value="{{post.slug}}"{% endif %}
                 placeholder="Leave blank for default">
        </div>
        <div class="post-date">
          <label for="post-date">Posted:</label>
          <input type="text" name="post-date" id="post-date"{% if post %} value="{{post|post_date_editable}}"{% endif %}>
        </div>
        <div class="post-ispublished">
          <input type="checkbox" name="post-ispublished" id="post-ispublished"{% if post.isPublished %} checked{% endif %}>
          <label for="post-ispublished">Published</label>
        </div>
        <div class="post-submit">
          <input type="submit" name="action" value="Save">
          <input type="submit" name="action" value="Save &amp; View">
          {% if post %}
            <a class="dont-save-just-view" href="/blog/{{post|post_url}}">Don't save, just view</a>
          {% endif %}
        </div>
    </fieldset>

    <input type="hidden" name="post-blobs" id="post-blobs" value="">
  </form>
  <fieldset id="post-images">
    <legend>Attachments</legend>
    {{ images(post, upload_url) }}
  </fieldset>
</div>
{%- endmacro %}

{% macro images(post, upload_url) -%}
  <script id="image-tmpl" type="text/html">
    <div class="uploaded-image">
      <img src="<%= url %>" width="100">
      <div class="details">
        <div>Filename: <%= filename %></div>
        <div>
          URL: <input type="text" value="<%= url %>" readonly onclick="this.select();">
          <a href="javascript:;" class="options">Options</a>
        </div>
      </div>
      <div style="clear: both;"></div>
    </div>
  </script>
  <div id="url-popup" style="display: none;">
    <fieldset>
      <legend>Image Options</legend>
      <p>Get a URL that'll display the image with certain customized settings (e.g. specific size, etc)</p>
      <div><label>Size:</label><input type="text" name="size" placeholder="New size"></div>
      <div><label>Crop:</label><input type="checkbox" name="crop" value="1"></div>
      <div><a href="javascript:;" class="url-popup-refresh">Refresh</a></div>
      <input type="text" class="url-popup-output" name="result"
             readonly placeholder="URL goes here" onclick="this.select()">
    </fieldset>

    <a href="javascript:;" onclick="$(&quot;#url-popup&quot;).popup(&quot;hide&quot;); return false;">Close</a>
  </div>

  <input type="file" id="image-upload">

  <script>
    $(function() {
      $("#post-content").markItUp(mySettings);
      $("#image-upload").uploadify({
        sendAsForm: true,
        onProgress: function(file, percent) {
          console.log("Progress: "+percent);
        },
        onUploadComplete: function(file, status, response) {
          if (status != 200) {
            alert("The upload has failed, sorry!");
            return;
          }

          append_image(response.blob_key, response);
        },

        uploadUrl: "{{upload_url}}"
      });

      function append_image(blob_key, info) {
        var url = "/blob/"+blob_key;
        if (info.url != "") {
          if (info.url.indexOf("http://0.0.0.0") >= 0) {
            info.url = info.url.replace("http://0.0.0.0", "http://localhost");
          }
          url = info.url;
        }
        var dom = $($("#image-tmpl").applyTemplate({
            url: url,
            filename: info.filename
          }));
        $("a.options", dom).click(function() {
          $("#url-popup").popup("show");
          $("a.url-popup-refresh").data("blob_key", blob_key);
        });
        $("#image-upload").before(dom);

        var blob_keys = $("#post-blobs").val();
        if (blob_keys != "") {
          blob_keys = JSON.parse(blob_keys);
        } else {
          blob_keys = [];
        }
        blob_keys.push(blob_key);
        $("#post-blobs").val(JSON.stringify(blob_keys));
      }

      function init(blob_key) {
        $.ajax({
          type: "POST",
          data: {"size": 100},
          url: "/blob/"+blob_key+"/info",
          success: function(data) {
            append_image(blob_key, data);
          }
        });
      }
      {% for blob_key in post.blobs %}
        init("{{blob_key}}");
      {% endfor %}

      $("#url-popup").popup({width: "400px", height: "230px"});
      $("body").on("click", "#url-popup a.url-popup-refresh", function() {
        var blobKey = $(this).data("blob_key");
        var container = $(this).parents("#url-popup");

        var data = {};
        var size = $("input[name=size]", container).val();
        if (size != "") {
          data["size"] = size;
        }
        var crop = $("input[name=crop]", container).prop("checked");
        if (crop) {
          data["crop"] = "1";
        }

        $.ajax({
          type: "POST",
          data: data,
          url: "/blob/"+blobKey+"/info",
          success: function(data) {
            $("input[name=result]", container).val(data.url);
          }
        });
      });
    });
  </script>
{%- endmacro %}