/*
 Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){var k=function(a){function c(g,b){return g.replace("=s100","=s"+b)}function f(g,b){var e=b.getContentElement("info","filename");e.setValue("Starting...");CKEDITOR.ajax.load("/blob/upload-url",function(c){c=JSON.parse(c).upload_url;console.log("Uploading to: "+c);var a=new XMLHttpRequest;a.upload.addEventListener("progress",function(b){b.lengthComputable&&(b=Math.round(100*b.loaded/b.total),e.setValue(g.name+" ... "+b+"%"))},!1);a.onreadystatechange=function(){4==a.readyState&&(resp=JSON.parse(a.responseText),
d(b,resp))};a.open("POST",c,!0);a.setRequestHeader("X-File-Name",g.name);a.setRequestHeader("X-File-Type",g.type);c=new FormData;c.append("file",g);a.send(c)})}function d(a,b){var e=a.getContentElement("info","filename");e.setValue(b.filename+" ("+b.width+"x"+b.height+")");e.getElement().data("resp",i.encode(JSON.stringify(b)));var d=CKEDITOR.document.getById(h),e=0,e=b.width>b.height?d.getParent().getSize("width"):d.getParent().getSize("height");d.setAttribute("src",c(b.url,e));d=0;(d=b.width>b.height?
a.imageElement.getAttribute("width"):a.imageElement.getAttribute("height"))||(d=400);a.getContentElement("info","size").setValue(d);d=a.getContentElement("info","lightbox");a.linkElement?d.setValue(!0):d.setValue(!1);a.imageElement.setAttribute("src",c(b.url,e));a.imageElement.setAttribute("data-blobinfo",i.encode(JSON.stringify(b)))}var h=CKEDITOR.tools.getNextId()+"_previewImage";return{title:"Image Properties",minWidth:420,minHeight:360,onShow:function(){this.linkEditMode=this.imageEditMode=this.linkElement=
this.imageElement=!1;this.firstLoad=!0;this.addLink=!1;var a=this.getParentEditor(),b=a.getSelection(),e=(b=b&&b.getSelectedElement())&&a.elementPath(b).contains("a",1);if(e){this.linkElement=e;this.linkEditMode=!0;var c=e.getChildren();1==c.count()&&"img"==c.getItem(0).getName()&&(this.imageElement=c.getItem(0),this.imageEditMode=!0);this.setupContent(1,e)}b&&("img"==b.getName()&&!b.data("cke-realelement"))&&(this.imageEditMode=!0,this.imageElement=b);this.imageEditMode?(this.originalImageElement=
this.imageElement,this.imageElement=this.originalImageElement.clone(!0,!0),this.setupContent(2,this.imageElement)):this.imageElement=a.document.createElement("img")},onOk:function(){this.imageEditMode?(this.imageElement=this.originalImageElement,delete this.originalImageElement):(this.imageElement=a.document.createElement("img"),this.imageElement.setAttribute("alt",""));this.linkEditMode||(this.linkElement=a.document.createElement("a"));this.commitContent(2,this.imageElement);this.commitContent(1,
this.linkElement);this.imageElement.getAttribute("style")||this.imageElement.removeAttribute("style");this.imageEditMode?!this.linkEditMode&&this.addLink?(a.insertElement(this.linkElement),this.imageElement.appendTo(this.linkElement)):this.linkEditMode&&!this.addLink&&(this.linkElement.remove(1),a.insertElement(this.imageElement)):this.addLink?this.linkEditMode?a.insertElement(this.imageElement):(a.insertElement(this.linkElement),this.linkElement.append(this.imageElement,!1)):a.insertElement(this.imageElement)},
onHide:function(){delete this.imageElement},contents:[{id:"info",label:a.lang.image.infoTab,accessKey:"I",elements:[{type:"vbox",padding:0,children:[{type:"hbox",widths:["290px","100px"],align:"right",children:[{id:"filename",type:"text",label:"Filename",onLoad:function(){this.getElement().setAttribute("disabled","disabled")},commit:function(a,b){var e=JSON.parse(i.decode(this.getElement().data("resp")));if(2==a){var d=this.getDialog().getContentElement("info","size"),e=c(e.url,d.getValue());b.setAttribute("src",
e);b.data("cke-saved-src",e);b.data("resp",this.getElement().data("resp"))}},setup:function(a,b){if(2==a){var e=JSON.parse(i.decode(b.data("resp")));d(this.getDialog(),e)}}},{type:"button",id:"browse",style:"display: inline-block; margin-top: 14px;",label:"Browse",onLoad:function(){var a=this.getDialog(),b=CKEDITOR.document.createElement("input");b.setAttribute("type","file");b.on("change",function(b){f(b.sender.$.files[0],a)});b.setAttribute("style","position: absolute; visibility: collapse");this.getElement().getParent().append(b);
this.on("click",function(){var a=document.createEvent("HTMLEvents");a.initEvent("click",!0,!0);b.$.dispatchEvent(a)})}}]}]},{id:"caption",type:"text",label:"Caption",accessKey:"T","default":"",setup:function(a,b){2==a&&this.setValue(b.getAttribute("alt"))},commit:function(a,b){2==a?(this.getValue()||this.isChanged())&&b.setAttribute("alt",this.getValue()):1==a?b.setAttribute("title",this.getValue()):3==a&&b.removeAttribute("alt")}},{type:"hbox",widths:["110px","280px"],align:"left",children:[{type:"vbox",
children:[{id:"size",type:"text",label:"Size"},{id:"lightbox",type:"checkbox",label:"Lightbox",commit:function(a,b){if(this.getValue()){this.getDialog().addLink=!0;var e=JSON.parse(i.decode(this.getDialog().getContentElement("info","filename").getElement().data("resp")));1==a&&(b.setAttribute("class","lightbox"),b.setAttribute("href",c(e.url,Math.max(e.width,e.height))))}else this.getDialog().addLink=!1}},{id:"float",label:"Float",type:"select",items:[["None",""],["Left","left"],["Right","right"]],
setup:function(a,b){if(2==a){var c=b.getStyle("float");if("none"==c||"inherit"==c)c="";this.setValue(c)}},commit:function(a,b){if(2==a){var c=this.getValue();b.removeClass("float-left");b.removeClass("float-right");b.removeStyle("float");c&&(b.addClass("float-"+c),b.setStyle("float",c))}}}]},{type:"html",html:'<div style="width: 100%; height: 200px; border: solid 1px #000; text-align: center;"><img src="" id="'+h+'" /></div>'}]}]}]}};CKEDITOR.dialog.add("imgblob",function(a){return k(a,"imgblob")});
var i={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){for(var c="",f,d,h,g,b,e,j=0,a=i._utf8_encode(a);j<a.length;)f=a.charCodeAt(j++),d=a.charCodeAt(j++),h=a.charCodeAt(j++),g=f>>2,f=(f&3)<<4|d>>4,b=(d&15)<<2|h>>6,e=h&63,isNaN(d)?b=e=64:isNaN(h)&&(e=64),c=c+this._keyStr.charAt(g)+this._keyStr.charAt(f)+this._keyStr.charAt(b)+this._keyStr.charAt(e);return c},decode:function(a){for(var c="",f,d,h,g,b,e=0,a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");e<a.length;)f=
this._keyStr.indexOf(a.charAt(e++)),d=this._keyStr.indexOf(a.charAt(e++)),g=this._keyStr.indexOf(a.charAt(e++)),b=this._keyStr.indexOf(a.charAt(e++)),f=f<<2|d>>4,d=(d&15)<<4|g>>2,h=(g&3)<<6|b,c+=String.fromCharCode(f),64!=g&&(c+=String.fromCharCode(d)),64!=b&&(c+=String.fromCharCode(h));return c=i._utf8_decode(c)},_utf8_encode:function(a){for(var a=a.replace(/\r\n/g,"\n"),c="",f=0;f<a.length;f++){var d=a.charCodeAt(f);128>d?c+=String.fromCharCode(d):(127<d&&2048>d?c+=String.fromCharCode(d>>6|192):
(c+=String.fromCharCode(d>>12|224),c+=String.fromCharCode(d>>6&63|128)),c+=String.fromCharCode(d&63|128))}return c},_utf8_decode:function(a){for(var c="",f=0,d=c1=c2=0;f<a.length;)d=a.charCodeAt(f),128>d?(c+=String.fromCharCode(d),f++):191<d&&224>d?(c2=a.charCodeAt(f+1),c+=String.fromCharCode((d&31)<<6|c2&63),f+=2):(c2=a.charCodeAt(f+1),c3=a.charCodeAt(f+2),c+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),f+=3);return c}}})();